<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Who is rich?">
    <Require feature="opensocial-0.8"/>
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  <Content type="html">
  
  <![CDATA[
  
    <script type="text/javascript" src="http://visapi-gadgets.googlecode.com/svn/trunk/pilesofmoney/pom.js"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>

    <script type="text/javascript">

        var usernames = {};
        var thumbnails = {};
        var selectedID = '';

        function getSwf(swfName) {
            return document.getElementById(swfName);
        }

        function sendToActionScript(value) {
            getSwf("campus_roamer").sendToActionScript(value);
        }

        function loadFriendsByUser(uid) {
            var req = opensocial.newDataRequest();

            if(uid.length == 0) {
                uid = "VIEWER";
            }
            else {
                var viewer = opensocial.newIdSpec({
                    "userId" : uid,
                    "groupId" : "SELF"
                });
                var opt_params = {};
                req.add(req.newFetchPeopleRequest(viewer, opt_params), 'viewer');
                selectedID =  uid;
            }
            req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER), 'viewer');

            var viewerFriends = opensocial.newIdSpec({
                "userId" : uid,
                "groupId" : "FRIENDS"
            });
            var opt_params = {};
            opt_params[opensocial.DataRequest.PeopleRequestFields.MAX] = 20;
            req.add(req.newFetchPeopleRequest(viewerFriends, opt_params), 'viewerFriends');

            req.send(onLoadFriendsByUser);
        }

        function onLoadFriendsByUser(data) {
            var viewerFriends = data.get('viewerFriends').getData();

            var uid = "";
            if(selectedID) {
                uid = selectedID;
            }
            else {
                var viewer = data.get('viewer').getData();
                uid = viewer.getId();
                usernames[uid] = viewer.getDisplayName();
                thumbnails[uid] = viewer.getField('thumbnailUrl');
            }

            // show my or selected photo
            me = new Array();
            me.push('<div><b>', usernames[uid], '</b><br>');
            me.push('<img src="', thumbnails[uid], '" />');
            me.push('</div>');
            document.getElementById('me').innerHTML = me.join('');

            // show friends' photo
            html = new Array();
            html.push('<div style="float:left; margin:5px; padding:5px;">');

            viewerFriends.each(   function(person) {
                if (person.getId()) {
                    html.push('<div style="float:left; width:50px; margin:5px; height:100px; padding:5px;">');
                    html.push('<a href="#" onclick="loadFriendsByUser(' + person.getId() + '); return false;"><img src="', person.getField('thumbnailUrl'), '" border="0" /></a><br>');
                    html.push(person.getDisplayName());
                    html.push('</div>');
                    usernames[person.getId()] = person.getDisplayName();
                    thumbnails[person.getId()] = person.getField('thumbnailUrl');
                }
            });

            html.push('</div>');
            document.getElementById('friends').innerHTML = html.join('');

            // construct xml for flex component
            var friends_xml = "<person><id>" + uid + "</id><name>" + usernames[uid] + "</name><thumbnail>" + thumbnails[uid] + "</thumbnail><friends>";
            viewerFriends.each(   function(person) {
                var id = person.getId();
                if(id) {
                    friends_xml += "<friend><id>" + id + "</id><name>" + usernames[id] + "</name><thumbnail>" + thumbnails[id] + "</thumbnail></friend>";
                }
            });
            friends_xml += "</friends></person>";

            sendToActionScript(friends_xml);
        }

        function init() {
            loadFriendsByUser("");

            // load spring graph
			var html = "<object classid='clsid:D27CDB6E-AE6D-11cf-96B8-444553540000'";
			html += "id='campus_roamer' width='100%' height='100%'";
			html += "codebase='http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab'>";
			html += "<param name='movie' value='PersonDemo.swf' />";
			html += "<param name='quality' value='high' />";
			html += "<param name='bgcolor' value='#869ca7' />";
			html += "<param name='allowScriptAccess' value='sameDomain' />";
			html += "<embed src='PersonDemo.swf' quality='high' bgcolor='#869ca7'";
			html += "width='100%' height='100%' name='campus_roamer' align='middle'";
			html += "play='true' loop='false' quality='high' allowScriptAccess='sameDomain'";
			html += "type='application/x-shockwave-flash' pluginspage='http://www.adobe.com/go/getflashplayer'>";
			html += "</embed>";
			html += "</object>";
			document.getElementById('flashcontainer').innerHTML = html;      

            google.load("visualization", "1");
            gadgets.window.adjustHeight();
        }

        gadgets.util.registerOnLoadHandler(init);
    </script>

    <div id='main'>
        <div id='flashcontainer'></div>
        <div id='me'></div>
        <div id='friends'></div>
    </div>

      
    ]]></Content>
</Module>
